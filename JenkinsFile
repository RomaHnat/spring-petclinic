//This is a Jenkins pipeline script for building, testing, packaging, and analyzing a Java project using SonarQube. It includes stages for checking out the code, building the project, running tests, packaging the application, performing SonarQube analysis, and checking the quality gate. The script also handles post-build actions based on the success or failure of the pipeline.
pipeline {
    agent any

    environment {
        SONAR_TOKEN = credentials('sonarqube-token') 
        MAVEN_CMD = './mvnw'
        PROJECT_KEY = 'spring-petclinic'
        SONAR_HOST = 'http://host.docker.internal:9000'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/RomaHnat/spring-petclinic.git'
            }
        }

        stage('Build') {
            steps {
                sh '${MAVEN_CMD} clean compile'
            }
        }

        stage('Test') {
            steps {
                sh '${MAVEN_CMD} test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Package') {
            steps {
                sh '${MAVEN_CMD} package'
            }
            post {
                always {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }

        stage('SonarQube Analysis & Quality Gate') {
            steps {
                withSonarQubeEnv('SonarQubeLocal') { 
                    sh '${MAVEN_CMD} clean verify sonar:sonar -Dsonar.projectKey=${PROJECT_KEY} -Dsonar.host.url=${SONAR_HOST} -Dsonar.login=${SONAR_TOKEN}'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Deploy with Docker') {
            steps {
                script {
                    echo 'Deploying application using Docker Compose...'
                    
                    // Stop and remove existing containers
                    sh 'docker compose down || true'
                    
                    // Build and deploy with Docker Compose V2
                    sh 'docker compose up -d --build petclinic'
                    
                    // Wait for application to start
                    sh 'sleep 10'
                    
                    // Verify deployment
                    sh '''
                        echo "Checking application health..."
                        docker ps | grep petclinic
                        curl -f http://localhost:8080/actuator/health || echo "Warning: Health check failed"
                    '''
                    
                    echo 'Application deployed successfully at http://localhost:8080'
                }
            }
        }
    }

    post {
        success {
            echo 'Build, test, and SonarQube analysis passed!'
        }
        failure {
            echo 'Build failed or Quality Gate failed!'
        }
    }
}
