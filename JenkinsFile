//This is a Jenkins pipeline script for building, testing, packaging, and analyzing a Java project using SonarQube. It includes stages for checking out the code, building the project, running tests, packaging the application, performing SonarQube analysis, and checking the quality gate. The script also handles post-build actions based on the success or failure of the pipeline.
pipeline {
    agent any

    environment {
        SONAR_TOKEN = credentials('sonarqube-token') 
        MAVEN_CMD = './mvnw'
        PROJECT_KEY = 'spring-petclinic'
        SONAR_HOST = 'http://host.docker.internal:9000'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/RomaHnat/spring-petclinic.git'
            }
        }

        stage('Build') {
            steps {
                sh '${MAVEN_CMD} clean compile'
            }
        }

        stage('Test') {
            steps {
                sh '${MAVEN_CMD} test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Package') {
            steps {
                sh '${MAVEN_CMD} package'
            }
            post {
                always {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }

        stage('SonarQube Analysis & Quality Gate') {
            steps {
                withSonarQubeEnv('SonarQubeLocal') { 
                    sh '${MAVEN_CMD} clean verify sonar:sonar -Dsonar.projectKey=${PROJECT_KEY} -Dsonar.host.url=${SONAR_HOST} -Dsonar.login=${SONAR_TOKEN}'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
    }

    post {
        success {
            echo 'Build, test, and SonarQube analysis passed!'
        }
        failure {
            echo 'Build failed or Quality Gate failed!'
        }
    }
}
