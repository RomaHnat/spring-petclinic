//This is a Jenkins pipeline script for building, testing, packaging, and analyzing a Java project using SonarQube. It includes stages for checking out the code, building the project, running tests, packaging the application, performing SonarQube analysis, and checking the quality gate. The script also handles post-build actions based on the success or failure of the pipeline.
pipeline {
    agent any

    environment {
        SONAR_TOKEN = credentials('sonarqube-token') 
        MAVEN_CMD = './mvnw'
        PROJECT_KEY = 'spring-petclinic'
        SONAR_HOST = 'http://host.docker.internal:9000'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/RomaHnat/spring-petclinic.git'
            }
        }

        stage('Build') {
            steps {
                sh '${MAVEN_CMD} clean compile'
            }
        }

        stage('Test') {
            steps {
                sh '${MAVEN_CMD} test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Package') {
            steps {
                sh '${MAVEN_CMD} package'
            }
            post {
                always {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }

        stage('SonarQube Analysis & Quality Gate') {
            steps {
                withSonarQubeEnv('SonarQubeLocal') { 
                    sh '${MAVEN_CMD} clean verify sonar:sonar -Dsonar.projectKey=${PROJECT_KEY} -Dsonar.host.url=${SONAR_HOST} -Dsonar.login=${SONAR_TOKEN}'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Deploy with Docker') {
            steps {
                script {
                    echo 'Deploying application using Docker...'
                    
                    // Stop and remove existing containers
                    sh '''
                        docker stop petclinic-app || true
                        docker rm petclinic-app || true
                        docker stop petclinic-mysql || true
                        docker rm petclinic-mysql || true
                    '''
                    
                    // Start MySQL database
                    sh '''
                        docker run -d \
                          --name petclinic-mysql \
                          -e MYSQL_ROOT_PASSWORD= \
                          -e MYSQL_ALLOW_EMPTY_PASSWORD=true \
                          -e MYSQL_USER=petclinic \
                          -e MYSQL_PASSWORD=petclinic \
                          -e MYSQL_DATABASE=petclinic \
                          -p 3307:3306 \
                          mysql:9.5
                    '''
                    
                    // Wait for MySQL to be ready
                    sh 'sleep 15'
                    
                    // Build application Docker image
                    sh 'docker build -t petclinic:latest .'
                    
                    // Run application container
                    sh '''
                        docker run -d \
                          --name petclinic-app \
                          -e SPRING_PROFILES_ACTIVE=mysql \
                          -e SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3307/petclinic \
                          -e SPRING_DATASOURCE_USERNAME=petclinic \
                          -e SPRING_DATASOURCE_PASSWORD=petclinic \
                          -p 8080:8080 \
                          petclinic:latest
                    '''
                    
                    // Wait for application to start
                    sh 'sleep 20'
                    
                    // Verify deployment
                    sh '''
                        echo "Checking containers..."
                        docker ps | grep petclinic || echo "Container not running"
                        docker logs petclinic-app --tail 50
                    '''
                    
                    echo 'Application deployed successfully at http://localhost:8080'
                }
            }
        }
    }

    post {
        success {
            echo 'Build, test, and SonarQube analysis passed!'
        }
        failure {
            echo 'Build failed or Quality Gate failed!'
        }
    }
}
